define(["underscore"],function(a){if(!a.deepExtend){var b={"*":function(a,b,c){a[b]=c},object:function(a,b,c){a[b]=e(a[b]||{},c)},array:function(c,e,f){c[e]=[],a.each(f,function(a,f){b[d(a)](c[e],f,a)},this)}},c=function(b){return a.isArray(b)?"array":a.isDate(b)?"date":a.isRegExp(b)?"regex":typeof b},d=function(a){var d=c(a);return b[d]?d:"*"},e=function(c){return a.each(f.call(arguments,1),function(e){a.each(e,function(a,e){b[d(a)](c,e,a)})}),c};a.mixin({deepExtend:e})}var f=[].slice,g="transition",h="handler",i=function(b){var c={};return a.each(b,function(a){c[a]=[]}),c},j=function(b){var c=b;return a.isArray(b)&&(c=i(b)),c},k={getHandlerNames:function(b){return a.uniq(a.flatten(a.map(b.states,function(b){return a.keys(b)})))},findProvider:function(){return window.postal?"postal":window.amplify?"amplify":undefined},makeFsmNamespace:function(){var a=0;return function(){return"fsm."+a++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],messaging:function(){var a=k.makeFsmNamespace();return{provider:k.findProvider(),eventNamespace:a+".events",handlerNamespace:a,subscriptions:[]}}()}},standardEventTransforms:{Handling:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Handled:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Transitioned:function(a){var b=a;return b.oldState=b[1],b.newState=b[2],delete b[1],delete b[2],b},InvalidState:function(a){var b=a;return b.currentState=b[1],b.attemptedState=b[2],delete b[1],delete b[2],b},NoHandler:function(a){var b=a;return b.eventType=b[1],delete b[1],b}}},l={},m=function(){var b={},c=function(a){a.messaging.subscriptions.push(postal.subscribe(a.messaging.handlerNamespace,"*",function(a,b){this.handle.call(this,b.topic,a)}).withContext(a))},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=a.deepExtend({},f.call(arguments,1));b[d]&&(e=b[d](e)),postal.publish(c.messaging.eventNamespace,d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){a.deepExtend(b,c)}}};l.postal=new m,l.postal.addEventTransforms(k.standardEventTransforms);var n=function(){var b={},c=function(b){a.each(k.getHandlerNames(b),function(a){b.messaging.subscriptions.push(amplify.subscribe(b.messaging.handlerNamespace+"."+a,b,function(b){this.handle.call(this,a,b)}))})},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=a.deepExtend({},f.call(arguments,1));b[d]&&(e=b[d](e)),amplify.publish(c.messaging.eventNamespace+"."+d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){a.deepExtend(b,c)}}};l.amplify=new n,l.amplify.addEventTransforms(k.standardEventTransforms);var o=function(b){var c,d,e=k.getDefaultOptions();b&&(b.eventListeners&&(b.eventListeners=j(b.eventListeners)),b.messaging&&(b.messaging=a.extend({},e.messaging,b.messaging))),c=a.extend(e,b||{}),d=c.initialState,delete c.initialState,a.extend(this,c),this.messaging.provider&&l[this.messaging.provider]&&l[this.messaging.provider].wireUp(this),this.state=undefined,this._priorAction="",this._currentAction="",d&&this.transition(d),p.eventListeners.fireEvent("newFsm",this)};o.prototype.fireEvent=function(b){var c=arguments;a.each(this.eventListeners["*"],function(a){try{a.apply(this,f.call(c,0))}catch(b){console&&typeof console.log!="undefined"&&console.log(b.toString())}}),this.eventListeners[b]&&a.each(this.eventListeners[b],function(a){try{a.apply(this,f.call(c,1))}catch(b){console&&typeof console.log!="undefined"&&console.log(b.toString())}})},o.prototype.handle=function(a){var b=this.states,c=this.state,d=f.call(arguments,0),e;this.currentActionArgs=d,b[c]&&(b[c][a]||b[c]["*"])?(e=b[c][a]?a:"*",this._currentAction=c+"."+e,this.fireEvent.apply(this,["Handling"].concat(d)),b[c][e].apply(this,d.slice(1)),this.fireEvent.apply(this,["Handled"].concat(d)),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(h)):this.fireEvent.apply(this,["NoHandler"].concat(d)),this.currentActionArgs=undefined},o.prototype.transition=function(a){if(this.states[a]){var b=this.state;this.state=a,this.states[a]._onEnter&&this.states[a]._onEnter.call(this),this.fireEvent.apply(this,["Transitioned",b,this.state]),this.processQueue(g);return}this.fireEvent.apply(this,["InvalidState",this.state,a])},o.prototype.processQueue=function(b){var c=b===g?function(a){return a.type===g&&(!a.untilState||a.untilState===this.state)}:function(a){return a.type===h},d=a.filter(this.eventQueue,c,this);this.eventQueue=a.difference(this.eventQueue,d),a.each(d,function(a,b){this.handle.apply(this,a.args)},this)},o.prototype.deferUntilTransition=function(a){if(this.currentActionArgs){var b={type:g,untilState:a,args:this.currentActionArgs};this.eventQueue.push(b),this.fireEvent.apply(this,["Deferred",this.state,b])}},o.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var a={type:g,args:this.currentActionArgs};this.eventQueue.push(a),this.fireEvent.apply(this,["Deferred",this.state,a])}},o.prototype.on=function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},o.prototype.off=function(b,c){this.eventListeners[b]&&(this.eventListeners[b]=a.without(this.eventListeners[b],c))};var p={Fsm:o,busProviders:l,utils:k,on:function(a,b){if(this.eventListeners[a]){this.eventListeners[a].push(b);return}throw new Error("Invalid Event Name '"+a+"'.")},off:function(b,c){throw this.eventListeners[b]&&(this.eventListeners[b]=a.without(this.eventListeners[b],c)),new Error("Invalid Event Name '"+b+"'.")},eventListeners:{fireEvent:function(b){var c=0,d,e=arguments;this[b]&&a.each(this[b],function(a){a.apply(null,f.call(e,1))})},newFsm:[]}};return p})