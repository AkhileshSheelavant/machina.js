define(["jquery","underscore"],function(a,b){if(!b.deepExtend){var c={"*":function(a,b,c){a[b]=c},object:function(a,b,c){a[b]=f(a[b]||{},c)},array:function(a,d,f){a[d]=[],b.each(f,function(b,f){c[e(b)](a[d],f,b)},this)}},d=function(a){return b.isArray(a)?"array":b.isDate(a)?"date":b.isRegExp(a)?"regex":typeof a},e=function(a){var b=d(a);return c[b]?b:"*"},f=function(a){return b.each(g.call(arguments,1),function(d){b.each(d,function(b,d){c[e(b)](a,d,b)})}),a};b.mixin({deepExtend:f})}var g=[].slice,h="transition",i="handler",j=function(a){var c={};return b.each(a,function(a){c[a]=[]}),c},k=function(a){var c=a;return b.isArray(a)&&(c=j(a)),c},l={getHandlerNames:function(a){return b.uniq(b.flatten(b.map(a.states,function(a){return b.keys(a)})))},findProvider:function(){return window.postal?"postal":window.amplify?"amplify":undefined},makeFsmNamespace:function(){var a=0;return function(){return"fsm."+a++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},stateBag:{},eventQueue:[],messaging:function(){var a=l.makeFsmNamespace();return{provider:l.findProvider(),eventNamespace:a+".events",handlerNamespace:a,subscriptions:[]}}()}},standardEventTransforms:{Handling:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Handled:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Transitioned:function(a){var b=a;return b.oldState=b[1],b.newState=b[2],delete b[1],delete b[2],b},InvalidState:function(a){var b=a;return b.currentState=b[1],b.attemptedState=b[2],delete b[1],delete b[2],b},NoHandler:function(a){var b=a;return b.eventType=b[1],delete b[1],b}}},m={},n=function(){var a={},c=function(a){a.messaging.subscriptions.push(postal.subscribe(a.messaging.handlerNamespace,"*",function(a,b){this.handle.call(this,b.topic,a)}).withContext(a))},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=b.deepExtend({},g.call(arguments,1));a[d]&&(e=a[d](e)),postal.publish(c.messaging.eventNamespace,d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){b.deepExtend(a,c)}}};m.postal=new n,m.postal.addEventTransforms(l.standardEventTransforms);var o=function(){var a={},c=function(a){b.each(l.getHandlerNames(a),function(b){a.messaging.subscriptions.push(amplify.subscribe(a.messaging.handlerNamespace+"."+b,a,function(a){this.handle.call(this,b,a)}))})},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=b.deepExtend({},g.call(arguments,1));a[d]&&(e=a[d](e)),amplify.publish(c.messaging.eventNamespace+"."+d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){b.deepExtend(a,c)}}};m.amplify=new o,m.amplify.addEventTransforms(l.standardEventTransforms);var p=function(a){var c,d,e=l.getDefaultOptions();a&&(a.eventListeners&&(a.eventListeners=k(a.eventListeners)),a.messaging&&(a.messaging=b.extend({},e.messaging,a.messaging))),c=b.extend({stateBag:{_priorAction:"",_currentAction:""}},e,a||{}),d=c.initialState,delete c.initialState,b.extend(this,c),this.messaging.provider&&m[this.messaging.provider]&&m[this.messaging.provider].wireUp(this),this.state=undefined,d&&this.transition(d),q.eventListeners.fireEvent("newFsm",this)};p.prototype.fireEvent=function(a){var c=0,d,e=arguments;b.each(this.eventListeners["*"],function(a){a.apply(this,g.call(e,0))}),this.eventListeners[a]&&b.each(this.eventListeners[a],function(a){a.apply(this,g.call(e,1))})},p.prototype.handle=function(a){var b=this.states,c=this.state,d=this.stateBag,e=g.call(arguments,0),f;this.currentActionArgs=e,b[c]&&(b[c][a]||b[c]["*"])?(f=b[c][a]?a:"*",d._currentAction=c+"."+f,this.fireEvent.apply(this,["Handling",d].concat(e)),b[c][f].apply(this,[d].concat(e.slice(1))),this.fireEvent.apply(this,["Handled",d].concat(e)),d._priorAction=d._currentAction,d._currentAction="",this.processQueue(i)):this.fireEvent.apply(this,["NoHandler",d].concat(e)),this.currentActionArgs=undefined},p.prototype.transition=function(a){if(this.states[a]){var b=this.state;this.state=a,this.states[a]._onEnter&&this.states[a]._onEnter.call(this,this.stateBag),this.fireEvent.apply(this,["Transitioned",this.stateBag,b,this.state]),this.processQueue(h);return}this.fireEvent.apply(this,["InvalidState",this.stateBag,this.state,a])},p.prototype.processQueue=function(a){var c=a===h?function(a){return a.type===h&&(!a.untilState||a.untilState===this.state)}:function(a){return a.type===i},d=b.filter(this.eventQueue,c,this);this.eventQueue=b.difference(this.eventQueue,d),b.each(d,function(a,b){this.handle.apply(this,a.args)},this)},p.prototype.deferUntilTransition=function(a){if(this.currentActionArgs){var b={type:h,untilState:a,args:this.currentActionArgs};this.eventQueue.push(b),this.fireEvent.apply(this,["Deferred",this.stateBag,this.state,b])}},p.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var a={type:h,args:this.currentActionArgs};this.eventQueue.push(a),this.fireEvent.apply(this,["Deferred",this.stateBag,this.state,a])}},p.prototype.on=function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},p.prototype.off=function(a,c){this.eventListeners[a]&&b.without(this.eventListeners[a],c)};var q={Fsm:p,busProviders:m,utils:l,on:function(a,b){if(this.eventListeners[a]){this.eventListeners[a].push(b);return}throw new Error("Invalid Event Name '"+a+"'.")},off:function(a,c){throw this.eventListeners[a]&&b.without(this.eventListeners[a],c),new Error("Invalid Event Name '"+a+"'.")},eventListeners:{fireEvent:function(a){var c=0,d,e=arguments;this[a]&&b.each(this[a],function(a){a.apply(null,g.call(e,1))})},newFsm:[]}};return q})