/*
 machina
 Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT (http://www.opensource.org/licenses/mit-license) & GPL (http://www.opensource.org/licenses/gpl-license)
 Version 0.2.1
 */
(function(e,t,n){typeof define=="function"&&define.amd?define(["underscore"],function(r){return n(r,e,t)}):n(e._,e,t)})(this,document,function(e,t,n,r){var i=[].slice,s="transition",o="handler",u=function(t){var n={};return e.each(t,function(e){n[e]=[]}),n},a=function(t){var n=t;return e.isArray(t)&&(n=u(t)),n},f={makeFsmNamespace:function(){var e=0;return function(){return"fsm."+e++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:f.makeFsmNamespace()}}},l=function(t){var n,i,s=f.getDefaultOptions();t&&(t.eventListeners&&(t.eventListeners=a(t.eventListeners)),t.messaging&&(t.messaging=e.extend({},s.messaging,t.messaging))),n=e.extend(s,t||{}),i=n.initialState,delete n.initialState,e.extend(this,n),this.state=r,this.priorState=r,this._priorAction="",this._currentAction="",i&&this.transition(i),c.fireEvent("newFsm",this)};l.prototype.fireEvent=function(t){var n=arguments;e.each(this.eventListeners["*"],function(e){try{e.apply(this,i.call(n,0))}catch(t){console&&typeof console.log!="undefined"&&console.log(t.toString())}}),this.eventListeners[t]&&e.each(this.eventListeners[t],function(e){try{e.apply(this,i.call(n,1))}catch(t){console&&typeof console.log!="undefined"&&console.log(t.toString())}})},l.prototype.handle=function(e){var t=this.states,n=this.state,s=i.call(arguments,0),u;this.currentActionArgs=s,t[n]&&(t[n][e]||t[n]["*"])?(u=t[n][e]?e:"*",this._currentAction=n+"."+u,this.fireEvent.apply(this,["Handling"].concat(s)),t[n][u].apply(this,s.slice(1)),this.fireEvent.apply(this,["Handled"].concat(s)),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(o)):this.fireEvent.apply(this,["NoHandler"].concat(s)),this.currentActionArgs=r},l.prototype.transition=function(e){if(this.states[e]){this.priorState=this.state,this.state=e,this.fireEvent.apply(this,["Transitioning",this.priorState,this.state]),this.states[e]._onEnter&&this.states[e]._onEnter.call(this),this.fireEvent.apply(this,["Transitioned",this.priorState,this.state]),this.processQueue(s);return}this.fireEvent.apply(this,["InvalidState",this.state,e])},l.prototype.processQueue=function(t){var n=t===s?function(e){return e.type===s&&(!e.untilState||e.untilState===this.state)}:function(e){return e.type===o},r=e.filter(this.eventQueue,n,this);this.eventQueue=e.difference(this.eventQueue,r),e.each(r,function(e,t){this.handle.apply(this,e.args)},this)},l.prototype.deferUntilTransition=function(e){if(this.currentActionArgs){var t={type:s,untilState:e,args:this.currentActionArgs};this.eventQueue.push(t),this.fireEvent.apply(this,["Deferred",this.state,t])}},l.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var e={type:s,args:this.currentActionArgs};this.eventQueue.push(e),this.fireEvent.apply(this,["Deferred",this.state,e])}},l.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},l.prototype.off=function(t,n){this.eventListeners[t]&&(this.eventListeners[t]=e.without(this.eventListeners[t],n))};var c={Fsm:l,bus:r,utils:f,on:function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},off:function(t,n){this.eventListeners[t]&&(this.eventListeners[t]=e.without(this.eventListeners[t],n))},fireEvent:function(t){var n=0,r,s=arguments,o=this.eventListeners[t];o&&o.length&&e.each(o,function(e){e.apply(null,i.call(s,1))})},eventListeners:{newFsm:[]}};return t.machina=c,c})