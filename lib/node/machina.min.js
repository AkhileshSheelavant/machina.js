this._=require("underscore");if(!_.deepExtend){var behavior={"*":function(a,b,c){a[b]=c},object:function(a,b,c){a[b]=deepExtend(a[b]||{},c)},array:function(a,b,c){a[b]=[],_.each(c,function(c,d){behavior[getHandlerName(c)](a[b],d,c)},this)}},getActualType=function(a){return _.isArray(a)?"array":_.isDate(a)?"date":_.isRegExp(a)?"regex":typeof a},getHandlerName=function(a){var b=getActualType(a);return behavior[b]?b:"*"},deepExtend=function(a){return _.each(slice.call(arguments,1),function(b){_.each(b,function(b,c){behavior[getHandlerName(b)](a,c,b)})}),a};_.mixin({deepExtend:deepExtend})}var slice=[].slice,NEXT_TRANSITION="transition",NEXT_HANDLER="handler",transformEventListToObject=function(a){var b={};return _.each(a,function(a){b[a]=[]}),b},parseEventListeners=function(a){var b=a;return _.isArray(a)&&(b=transformEventListToObject(a)),b},utils={getHandlerNames:function(a){return _.uniq(_.flatten(_.map(a.states,function(a){return _.keys(a)})))},findProvider:function(){return window.postal?"postal":window.amplify?"amplify":undefined},makeFsmNamespace:function(){var a=0;return function(){return"fsm."+a++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],messaging:function(){var a=utils.makeFsmNamespace();return{provider:utils.findProvider(),eventNamespace:a+".events",handlerNamespace:a,subscriptions:[]}}()}},standardEventTransforms:{Handling:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Handled:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Transitioned:function(a){var b=a;return b.oldState=b[1],b.newState=b[2],delete b[1],delete b[2],b},InvalidState:function(a){var b=a;return b.currentState=b[1],b.attemptedState=b[2],delete b[1],delete b[2],b},NoHandler:function(a){var b=a;return b.eventType=b[1],delete b[1],b}}},messageBusProvider={},PostalFsmProvider=function(){var a={},b=function(a){a.messaging.subscriptions.push(postal.subscribe(a.messaging.handlerNamespace,"*",function(a,b){this.handle.call(this,b.topic,a)}).withContext(a))},c=function(b){b.messaging.eventPublisher=function(){var c=arguments[0],d=_.deepExtend({},slice.call(arguments,1));a[c]&&(d=a[c](d)),postal.publish(b.messaging.eventNamespace,c,d)},b.on("*",b.messaging.eventPublisher)};return{wireUp:function(a){b(a),c(a)},addEventTransforms:function(b){_.deepExtend(a,b)}}};messageBusProvider.postal=new PostalFsmProvider,messageBusProvider.postal.addEventTransforms(utils.standardEventTransforms);var AmplifyFsmProvider=function(){var a={},b=function(a){_.each(utils.getHandlerNames(a),function(b){a.messaging.subscriptions.push(amplify.subscribe(a.messaging.handlerNamespace+"."+b,a,function(a){this.handle.call(this,b,a)}))})},c=function(b){b.messaging.eventPublisher=function(){var c=arguments[0],d=_.deepExtend({},slice.call(arguments,1));a[c]&&(d=a[c](d)),amplify.publish(b.messaging.eventNamespace+"."+c,d)},b.on("*",b.messaging.eventPublisher)};return{wireUp:function(a){b(a),c(a)},addEventTransforms:function(b){_.deepExtend(a,b)}}};messageBusProvider.amplify=new AmplifyFsmProvider,messageBusProvider.amplify.addEventTransforms(utils.standardEventTransforms);var Fsm=function(a){var b,c,d=utils.getDefaultOptions();a&&(a.eventListeners&&(a.eventListeners=parseEventListeners(a.eventListeners)),a.messaging&&(a.messaging=_.extend({},d.messaging,a.messaging))),b=_.extend(d,a||{}),c=b.initialState,delete b.initialState,_.extend(this,b),this.messaging.provider&&messageBusProvider[this.messaging.provider]&&messageBusProvider[this.messaging.provider].wireUp(this),this.state=undefined,this._priorAction="",this._currentAction="",c&&this.transition(c),machina.eventListeners.fireEvent("newFsm",this)};Fsm.prototype.fireEvent=function(a){var b=arguments;_.each(this.eventListeners["*"],function(a){try{a.apply(this,slice.call(b,0))}catch(c){console&&typeof console.log!="undefined"&&console.log(c.toString())}}),this.eventListeners[a]&&_.each(this.eventListeners[a],function(a){try{a.apply(this,slice.call(b,1))}catch(c){console&&typeof console.log!="undefined"&&console.log(c.toString())}})},Fsm.prototype.handle=function(a){var b=this.states,c=this.state,d=slice.call(arguments,0),e;this.currentActionArgs=d,b[c]&&(b[c][a]||b[c]["*"])?(e=b[c][a]?a:"*",this._currentAction=c+"."+e,this.fireEvent.apply(this,["Handling"].concat(d)),b[c][e].apply(this,d.slice(1)),this.fireEvent.apply(this,["Handled"].concat(d)),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(NEXT_HANDLER)):this.fireEvent.apply(this,["NoHandler"].concat(d)),this.currentActionArgs=undefined},Fsm.prototype.transition=function(a){if(this.states[a]){var b=this.state;this.state=a,this.states[a]._onEnter&&this.states[a]._onEnter.call(this),this.fireEvent.apply(this,["Transitioned",b,this.state]),this.processQueue(NEXT_TRANSITION);return}this.fireEvent.apply(this,["InvalidState",this.state,a])},Fsm.prototype.processQueue=function(a){var b=a===NEXT_TRANSITION?function(a){return a.type===NEXT_TRANSITION&&(!a.untilState||a.untilState===this.state)}:function(a){return a.type===NEXT_HANDLER},c=_.filter(this.eventQueue,b,this);this.eventQueue=_.difference(this.eventQueue,c),_.each(c,function(a,b){this.handle.apply(this,a.args)},this)},Fsm.prototype.deferUntilTransition=function(a){if(this.currentActionArgs){var b={type:NEXT_TRANSITION,untilState:a,args:this.currentActionArgs};this.eventQueue.push(b),this.fireEvent.apply(this,["Deferred",this.state,b])}},Fsm.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var a={type:NEXT_TRANSITION,args:this.currentActionArgs};this.eventQueue.push(a),this.fireEvent.apply(this,["Deferred",this.state,a])}},Fsm.prototype.on=function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},Fsm.prototype.off=function(a,b){this.eventListeners[a]&&(this.eventListeners[a]=_.without(this.eventListeners[a],b))};var machina={Fsm:Fsm,busProviders:messageBusProvider,utils:utils,on:function(a,b){if(this.eventListeners[a]){this.eventListeners[a].push(b);return}throw new Error("Invalid Event Name '"+a+"'.")},off:function(a,b){throw this.eventListeners[a]&&(this.eventListeners[a]=_.without(this.eventListeners[a],b)),new Error("Invalid Event Name '"+a+"'.")},eventListeners:{fireEvent:function(a){var b=0,c,d=arguments;this[a]&&_.each(this[a],function(a){a.apply(null,slice.call(d,1))})},newFsm:[]}};module.exports=machina