(function(a,b,c){typeof define=="function"&&define.amd?define(["underscore"],function(d){return c(d,a,b)}):c(a._,a,b)})(this,document,function(a,b,c,d){var e=[].slice,f="transition",g="handler",h=function(b){var c={};return a.each(b,function(a){c[a]=[]}),c},i=function(b){var c=b;return a.isArray(b)&&(c=h(b)),c},j={makeFsmNamespace:function(){var a=0;return function(){return"fsm."+a++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:j.makeFsmNamespace()}}},k=function(b){var c,e,f=j.getDefaultOptions();b&&(b.eventListeners&&(b.eventListeners=i(b.eventListeners)),b.messaging&&(b.messaging=a.extend({},f.messaging,b.messaging))),c=a.extend(f,b||{}),e=c.initialState,delete c.initialState,a.extend(this,c),this.state=d,this._priorAction="",this._currentAction="",e&&this.transition(e),l.fireEvent("newFsm",this)};k.prototype.fireEvent=function(b){var c=arguments;a.each(this.eventListeners["*"],function(a){try{a.apply(this,e.call(c,0))}catch(b){console&&typeof console.log!="undefined"&&console.log(b.toString())}}),this.eventListeners[b]&&a.each(this.eventListeners[b],function(a){try{a.apply(this,e.call(c,1))}catch(b){console&&typeof console.log!="undefined"&&console.log(b.toString())}})},k.prototype.handle=function(a){var b=this.states,c=this.state,f=e.call(arguments,0),h;this.currentActionArgs=f,b[c]&&(b[c][a]||b[c]["*"])?(h=b[c][a]?a:"*",this._currentAction=c+"."+h,this.fireEvent.apply(this,["Handling"].concat(f)),b[c][h].apply(this,f.slice(1)),this.fireEvent.apply(this,["Handled"].concat(f)),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(g)):this.fireEvent.apply(this,["NoHandler"].concat(f)),this.currentActionArgs=d},k.prototype.transition=function(a){if(this.states[a]){var b=this.state;this.state=a,this.states[a]._onEnter&&this.states[a]._onEnter.call(this),this.fireEvent.apply(this,["Transitioned",b,this.state]),this.processQueue(f);return}this.fireEvent.apply(this,["InvalidState",this.state,a])},k.prototype.processQueue=function(b){var c=b===f?function(a){return a.type===f&&(!a.untilState||a.untilState===this.state)}:function(a){return a.type===g},d=a.filter(this.eventQueue,c,this);this.eventQueue=a.difference(this.eventQueue,d),a.each(d,function(a,b){this.handle.apply(this,a.args)},this)},k.prototype.deferUntilTransition=function(a){if(this.currentActionArgs){var b={type:f,untilState:a,args:this.currentActionArgs};this.eventQueue.push(b),this.fireEvent.apply(this,["Deferred",this.state,b])}},k.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var a={type:f,args:this.currentActionArgs};this.eventQueue.push(a),this.fireEvent.apply(this,["Deferred",this.state,a])}},k.prototype.on=function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},k.prototype.off=function(b,c){this.eventListeners[b]&&(this.eventListeners[b]=a.without(this.eventListeners[b],c))};var l={Fsm:k,bus:d,utils:j,on:function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},off:function(b,c){this.eventListeners[b]&&(this.eventListeners[b]=a.without(this.eventListeners[b],c))},fireEvent:function(b){var c=0,d,f=arguments;this[b]&&a.each(this[b],function(a){a.apply(null,e.call(f,1))})},eventListeners:{newFsm:[]}};return b.machina=l,l})