var machina=function(a,b,c){if(!b.deepExtend){var d={"*":function(a,b,c){a[b]=c},object:function(a,b,c){a[b]=g(a[b]||{},c)},array:function(a,c,e){a[c]=[],b.each(e,function(b,e){d[f(b)](a[c],e,b)},this)}},e=function(a){return b.isArray(a)?"array":b.isDate(a)?"date":b.isRegExp(a)?"regex":typeof a},f=function(a){var b=e(a);return d[b]?b:"*"},g=function(a){return b.each(h.call(arguments,1),function(c){b.each(c,function(b,c){d[f(b)](a,c,b)})}),a};b.mixin({deepExtend:g})}var h=[].slice,i="transition",j="handler",k=function(a){var c={};return b.each(a,function(a){c[a]=[]}),c},l=function(a){var c=a;return b.isArray(a)&&(c=k(a)),c},m={getHandlerNames:function(a){return b.uniq(b.flatten(b.map(a.states,function(a){return b.keys(a)})))},findProvider:function(){return window.postal?"postal":window.amplify?"amplify":c},makeFsmNamespace:function(){var a=0;return function(){return"fsm."+a++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},stateBag:{},eventQueue:[],messaging:function(){var a=m.makeFsmNamespace();return{provider:m.findProvider(),eventNamespace:a+".events",handlerNamespace:a,subscriptions:[]}}()}},standardEventTransforms:{Handling:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Handled:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Transitioned:function(a){var b=a;return b.oldState=b[1],b.newState=b[2],delete b[1],delete b[2],b},InvalidState:function(a){var b=a;return b.currentState=b[1],b.attemptedState=b[2],delete b[1],delete b[2],b},NoHandler:function(a){var b=a;return b.eventType=b[1],delete b[1],b}}},n={},o=function(){var a={},c=function(a){a.messaging.subscriptions.push(postal.subscribe(a.messaging.handlerNamespace,"*",function(a,b){this.handle.call(this,b.topic,a)}).withContext(a))},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=b.deepExtend({},h.call(arguments,1));a[d]&&(e=a[d](e)),postal.publish(c.messaging.eventNamespace,d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){b.deepExtend(a,c)}}};n.postal=new o,n.postal.addEventTransforms(m.standardEventTransforms);var p=function(){var a={},c=function(a){b.each(m.getHandlerNames(a),function(b){a.messaging.subscriptions.push(amplify.subscribe(a.messaging.handlerNamespace+"."+b,a,function(a){this.handle.call(this,b,a)}))})},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=b.deepExtend({},h.call(arguments,1));a[d]&&(e=a[d](e)),amplify.publish(c.messaging.eventNamespace+"."+d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){b.deepExtend(a,c)}}};n.amplify=new p,n.amplify.addEventTransforms(m.standardEventTransforms);var q=function(a){var d,e,f=m.getDefaultOptions();a&&(a.eventListeners&&(a.eventListeners=l(a.eventListeners)),a.messaging&&(a.messaging=b.extend({},f.messaging,a.messaging))),d=b.extend({stateBag:{_priorAction:"",_currentAction:""}},f,a||{}),e=d.initialState,delete d.initialState,b.extend(this,d),this.messaging.provider&&n[this.messaging.provider]&&n[this.messaging.provider].wireUp(this),this.state=c,e&&this.transition(e),r.eventListeners.fireEvent("newFsm",this)};q.prototype.fireEvent=function(a){var c=0,d,e=arguments;b.each(this.eventListeners["*"],function(a){a.apply(this,h.call(e,0))}),this.eventListeners[a]&&b.each(this.eventListeners[a],function(a){a.apply(this,h.call(e,1))})},q.prototype.handle=function(a){var b=this.states,d=this.state,e=this.stateBag,f=h.call(arguments,0),g;this.currentActionArgs=f,b[d]&&(b[d][a]||b[d]["*"])?(g=b[d][a]?a:"*",e._currentAction=d+"."+g,this.fireEvent.apply(this,["Handling",e].concat(f)),b[d][g].apply(this,[e].concat(f.slice(1))),this.fireEvent.apply(this,["Handled",e].concat(f)),e._priorAction=e._currentAction,e._currentAction="",this.processQueue(j)):this.fireEvent.apply(this,["NoHandler",e].concat(f)),this.currentActionArgs=c},q.prototype.transition=function(a){if(this.states[a]){var b=this.state;this.state=a,this.states[a]._onEnter&&this.states[a]._onEnter.call(this,this.stateBag),this.fireEvent.apply(this,["Transitioned",this.stateBag,b,this.state]),this.processQueue(i);return}this.fireEvent.apply(this,["InvalidState",this.stateBag,this.state,a])},q.prototype.processQueue=function(a){var c=a===i?function(a){return a.type===i&&(!a.untilState||a.untilState===this.state)}:function(a){return a.type===j},d=b.filter(this.eventQueue,c,this);this.eventQueue=b.difference(this.eventQueue,d),b.each(d,function(a,b){this.handle.apply(this,a.args)},this)},q.prototype.deferUntilTransition=function(a){if(this.currentActionArgs){var b={type:i,untilState:a,args:this.currentActionArgs};this.eventQueue.push(b),this.fireEvent.apply(this,["Deferred",this.stateBag,this.state,b])}},q.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var a={type:i,args:this.currentActionArgs};this.eventQueue.push(a),this.fireEvent.apply(this,["Deferred",this.stateBag,this.state,a])}},q.prototype.on=function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},q.prototype.off=function(a,c){this.eventListeners[a]&&b.without(this.eventListeners[a],c)};var r={Fsm:q,busProviders:n,utils:m,on:function(a,b){if(this.eventListeners[a]){this.eventListeners[a].push(b);return}throw new Error("Invalid Event Name '"+a+"'.")},off:function(a,c){throw this.eventListeners[a]&&b.without(this.eventListeners[a],c),new Error("Invalid Event Name '"+a+"'.")},eventListeners:{fireEvent:function(a){var c=0,d,e=arguments;this[a]&&b.each(this[a],function(a){a.apply(null,h.call(e,1))})},newFsm:[]}};return r}(jQuery,_)